{"version":3,"sources":["turbopack:///[project]/app/lib/api-config.ts","turbopack:///[project]/app/publish/PublishClient.tsx/__nextjs-internal-proxy.mjs","turbopack:///[project]/app/publish/page.tsx"],"sourcesContent":["/**\n * Centralized API Configuration\n * \n * This module provides runtime URL resolution for API calls across the application.\n * It eliminates hardcoded localhost URLs and uses environment variables for flexibility.\n * \n * Architecture:\n * - Development: Next.js (3000) + Express (3001)\n * - Production VPS: NGINX proxy (80/443) â†’ Next.js (3000) + Express (3001)\n * - Production Replit: Single Next.js server (5000) with API routes\n */\n\n/**\n * Environment variable validation\n * Ensures required configuration is present at runtime\n * \n * PRODUCTION SAFETY: Throws errors for missing critical variables\n * DEVELOPMENT: Allows fallbacks with warnings\n */\nfunction validateEnv() {\n  const isProduction = process.env.NODE_ENV === 'production';\n\n  if (typeof window === 'undefined') {\n    // Server-side: require EXPRESS_URL in production\n    if (!process.env.EXPRESS_URL) {\n      if (isProduction) {\n        throw new Error(\n          'ðŸš¨ CRITICAL: EXPRESS_URL environment variable is required in production.\\n' +\n          'Please set it in your .env.production file.\\n' +\n          'Example: EXPRESS_URL=http://127.0.0.1:3001\\n' +\n          'For VPS deployment, see: VPS_DEPLOYMENT_GUIDE.md'\n        );\n      } else {\n        console.warn(\n          'âš ï¸  EXPRESS_URL not set, using development fallback: http://127.0.0.1:3001'\n        );\n      }\n    }\n  }\n\n  // NEXT_PUBLIC_SITE_URL is required in production for SEO, OG tags, canonical URLs\n  if (!process.env.NEXT_PUBLIC_SITE_URL) {\n    if (isProduction) {\n      throw new Error(\n        'ðŸš¨ CRITICAL: NEXT_PUBLIC_SITE_URL environment variable is required in production.\\n' +\n        'Please set it in your .env.production file.\\n' +\n        'Example: NEXT_PUBLIC_SITE_URL=https://yourdomain.com\\n' +\n        'This is used for SEO metadata, Open Graph tags, and canonical URLs.'\n      );\n    } else {\n      console.warn(\n        'âš ï¸  NEXT_PUBLIC_SITE_URL not set, using development fallback: http://localhost:3000'\n      );\n    }\n  }\n}\n\n// Run validation on module load\nvalidateEnv();\n\n/**\n * Get the API base URL for client-side requests\n * \n * @returns API base URL accessible from the browser\n * \n * Client-side behavior:\n * - Always returns empty string '' (uses relative URLs)\n * - Next.js rewrites handle /api/* â†’ Express server routing\n * - No need for absolute URLs on client-side\n * \n * Server-side behavior:\n * - Returns internal API URL (e.g., http://127.0.0.1:3001)\n * - Used for server-to-server communication\n * \n * Usage in client components:\n * ```typescript\n * const apiUrl = getApiBaseUrl();\n * fetch(`${apiUrl}/api/stats`);  // Becomes: fetch('/api/stats')\n * ```\n */\nexport function getApiBaseUrl(): string {\n  // Client-side: use relative URLs (NGINX/Next.js rewrites handle routing)\n  if (typeof window !== 'undefined') {\n    return '';\n  }\n\n  // Server-side: Use getInternalApiUrl which has production safety checks\n  return getInternalApiUrl();\n}\n\n/**\n * Get the internal API URL for server-side requests\n * \n * @returns Internal API URL for server-to-server communication\n * \n * Usage in server components:\n * ```typescript\n * const apiUrl = getInternalApiUrl();\n * const response = await fetch(`${apiUrl}/api/stats`);\n * ```\n */\nexport function getInternalApiUrl(): string {\n  // Server-side only\n  if (typeof window !== 'undefined') {\n    throw new Error('getInternalApiUrl() can only be called server-side');\n  }\n\n  const isProduction = process.env.NODE_ENV === 'production';\n  const url = process.env.EXPRESS_URL;\n  \n  if (!url) {\n    if (isProduction) {\n      throw new Error(\n        'EXPRESS_URL must be set in production. ' +\n        'This is a critical configuration error that will prevent server-side API calls from working.'\n      );\n    }\n    // Development fallback only\n    const fallback = 'http://127.0.0.1:3001';\n    console.log(`[API Config] Using development fallback: ${fallback}`);\n    return fallback;\n  }\n  \n  console.log(`[API Config] Internal API URL: ${url}`);\n  return url;\n}\n\n/**\n * Get the public site URL\n * \n * @returns Public-facing site URL (for SEO, OG tags, etc.)\n * \n * Usage:\n * ```typescript\n * const siteUrl = getSiteUrl();\n * const canonical = `${siteUrl}/thread/${slug}`;\n * ```\n */\nexport function getSiteUrl(): string {\n  const isProduction = process.env.NODE_ENV === 'production';\n  const siteUrl = process.env.NEXT_PUBLIC_SITE_URL || process.env.VERCEL_URL;\n  \n  if (!siteUrl) {\n    if (isProduction) {\n      throw new Error(\n        'NEXT_PUBLIC_SITE_URL must be set in production. ' +\n        'This is required for SEO, canonical URLs, and Open Graph tags.'\n      );\n    }\n    // Development fallback\n    return 'http://localhost:3000';\n  }\n  \n  return siteUrl;\n}\n\n/**\n * Build a full API URL with path\n * \n * @param path - API endpoint path (e.g., '/api/stats')\n * @returns Full API URL\n * \n * Usage:\n * ```typescript\n * const url = buildApiUrl('/api/stats');\n * const response = await fetch(url);\n * ```\n */\nexport function buildApiUrl(path: string): string {\n  const base = getApiBaseUrl();\n  const cleanPath = path.startsWith('/') ? path : `/${path}`;\n  return base ? `${base}${cleanPath}` : cleanPath;\n}\n\n/**\n * Configuration object for easy access\n */\nexport const apiConfig = {\n  /**\n   * API base URL (client or server appropriate)\n   */\n  baseUrl: getApiBaseUrl(),\n\n  /**\n   * Public site URL\n   */\n  siteUrl: getSiteUrl(),\n\n  /**\n   * Whether we're in production mode\n   */\n  isProduction: process.env.NODE_ENV === 'production',\n\n  /**\n   * Whether we're in development mode\n   */\n  isDevelopment: process.env.NODE_ENV === 'development',\n\n  /**\n   * Express API URL (server-side only)\n   */\n  get expressUrl(): string {\n    if (typeof window !== 'undefined') {\n      throw new Error('expressUrl is only available server-side');\n    }\n    return getInternalApiUrl();\n  },\n} as const;\n\n/**\n * Type-safe environment variable access\n * \n * Note: NEXT_PUBLIC_EXPRESS_URL is not included as client-side code\n * uses relative URLs (/api/*) which are handled by Next.js rewrites.\n */\nexport const env = {\n  // Server-side only\n  EXPRESS_URL: process.env.EXPRESS_URL,\n  DATABASE_URL: process.env.DATABASE_URL,\n  SESSION_SECRET: process.env.SESSION_SECRET,\n\n  // Public (client-accessible)\n  NEXT_PUBLIC_SITE_URL: process.env.NEXT_PUBLIC_SITE_URL,\n\n  // Node environment\n  NODE_ENV: process.env.NODE_ENV,\n} as const;\n\n// Export helper for debugging\nexport function debugConfig() {\n  if (typeof window === 'undefined') {\n    console.log('ðŸ”§ API Configuration (Server-side):');\n    console.log('  - Express URL:', env.EXPRESS_URL || 'NOT SET (using fallback)');\n    console.log('  - Site URL:', getSiteUrl());\n    console.log('  - API Base:', getApiBaseUrl());\n  } else {\n    console.log('ðŸ”§ API Configuration (Client-side):');\n    console.log('  - Site URL:', env.NEXT_PUBLIC_SITE_URL || 'NOT SET');\n    console.log('  - API Base:', getApiBaseUrl());\n  }\n}\n","// This file is generated by next-core EcmascriptClientReferenceModule.\nimport { registerClientReference } from \"react-server-dom-turbopack/server\";\nexport default registerClientReference(\n    function() { throw new Error(\"Attempted to call the default export of [project]/app/publish/PublishClient.tsx from the server, but it's on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/app/publish/PublishClient.tsx\",\n    \"default\",\n);\n","import { Metadata } from \"next\";\nimport { cookies } from \"next/headers\";\nimport { redirect } from \"next/navigation\";\nimport PublishClient from \"./PublishClient\";\nimport { getInternalApiUrl } from \"../lib/api-config\";\n\nexport const metadata: Metadata = {\n  title: \"Publish Content | YoForex\",\n  description: \"Share your expert advisors, indicators, and trading articles with the YoForex community. Earn coins for quality content.\",\n  keywords: \"publish, upload EA, share indicators, trading articles, content creator, MT4, MT5, forex, trading\",\n  openGraph: {\n    title: \"Publish Content | YoForex\",\n    description: \"Share your expert advisors, indicators, and trading articles with the YoForex community. Earn coins for quality content.\",\n    type: \"website\",\n  },\n  twitter: {\n    card: \"summary_large_image\",\n    title: \"Publish Content | YoForex\",\n    description: \"Share your expert advisors, indicators, and trading articles with the YoForex community. Earn coins for quality content.\",\n  },\n};\n\nasync function getCategories() {\n  const controller = new AbortController();\n  const timeout = setTimeout(() => controller.abort(), 10000); // 10s timeout\n  \n  try {\n    const cookieStore = await cookies();\n    const sessionCookie = cookieStore.get(\"connect.sid\");\n    const apiUrl = getInternalApiUrl();\n    \n    console.log(`[SSR Fetch] Fetching: ${apiUrl}/api/publish/categories`);\n    const response = await fetch(`${apiUrl}/api/publish/categories`, {\n      signal: controller.signal,\n      headers: sessionCookie ? { Cookie: `connect.sid=${sessionCookie.value}` } : {},\n      cache: \"no-store\",\n    });\n\n    clearTimeout(timeout);\n\n    if (!response.ok) {\n      console.error(`[SSR Fetch] Failed /api/publish/categories: ${response.status}`);\n      return [];\n    }\n\n    return response.json();\n  } catch (error) {\n    clearTimeout(timeout);\n    console.error(\"[SSR Fetch] Error fetching categories:\", error);\n    return [];\n  }\n}\n\nasync function checkAuth() {\n  const controller = new AbortController();\n  const timeout = setTimeout(() => controller.abort(), 10000); // 10s timeout\n  \n  try {\n    const cookieStore = await cookies();\n    const sessionCookie = cookieStore.get(\"connect.sid\");\n    \n    if (!sessionCookie) {\n      return null;\n    }\n\n    const apiUrl = getInternalApiUrl();\n    console.log(`[SSR Fetch] Fetching: ${apiUrl}/api/me`);\n    const response = await fetch(`${apiUrl}/api/me`, {\n      signal: controller.signal,\n      headers: { Cookie: `connect.sid=${sessionCookie.value}` },\n      cache: \"no-store\",\n    });\n\n    clearTimeout(timeout);\n\n    if (!response.ok) {\n      console.error(`[SSR Fetch] Failed /api/me: ${response.status}`);\n      return null;\n    }\n\n    return response.json();\n  } catch (error) {\n    clearTimeout(timeout);\n    console.error(\"[SSR Fetch] Error checking auth:\", error);\n    return null;\n  }\n}\n\nexport default async function PublishPage({\n  searchParams,\n}: {\n  searchParams: Promise<{ category?: string }>;\n}) {\n  // Check authentication\n  const user = await checkAuth();\n  if (!user) {\n    redirect(\"/\");\n  }\n\n  // Fetch categories\n  const categories = await getCategories();\n  \n  // Get category param\n  const params = await searchParams;\n  const categoryParam = params.category;\n\n  return <PublishClient initialCategories={categories} categoryParam={categoryParam} />;\n}\n"],"names":[],"mappings":"qUAqGO,SAAS,IAOd,IAAM,EAAA,wBAgBN,OADA,QAAQ,GAAG,CAAC,CAAC,+BAA+B,EAAE,EAAA,CAAK,EAC5C,CACT,CAtCS,IAmIO,QAAQ,GAAG,CAAC,YAAY,CACtB,QAAQ,GAAG,CAAC,cAAc,gECzN7B,CAAA,EADf,AACe,EADf,CAAA,CAAA,OACe,uBAAA,AAAuB,EAClC,WAAa,MAAM,AAAI,MAAM,+RAAiS,EAC9T,8DACA,8DAHW,CAAA,EADf,AACe,EADf,CAAA,CAAA,OACe,uBAAA,AAAuB,EAClC,WAAa,MAAM,AAAI,MAAM,2QAA6Q,EAC1S,0CACA,mICJJ,EAAA,EAAA,CAAA,CAAA,MACA,EAAA,CAAA,CAAA,OAAA,IAAA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OAkBA,eAAe,IACb,IAAM,EAAa,IAAI,gBACjB,EAAU,WAAW,IAAM,EAAW,KAAK,GAAI,KAErD,GAF6D,AAEzD,CAEF,IAAM,EAAgB,CADF,MAHqD,AAG/C,CAAA,EAAA,EAAA,OAAO,AAAP,GAAO,EACC,GAAG,CAAC,eAChC,EAAS,CAAA,EAAA,EAAA,iBAAA,AAAiB,IAEhC,QAAQ,GAAG,CAAC,CAAC,sBAAsB,EAAE,EAAO,uBAAuB,CAAC,EACpE,IAAM,EAAW,MAAM,MAAM,CAAA,EAAG,EAAO,uBAAuB,CAAC,CAAE,CAC/D,OAAQ,EAAW,MAAM,CACzB,QAAS,EAAgB,CAAE,OAAQ,CAAC,YAAY,EAAE,EAAc,KAAK,CAAA,CAAG,AAAD,EAAK,CAAC,EAC7E,MAAO,UACT,GAIA,GAFA,aAAa,GAET,CAAC,EAAS,EAAE,CAEd,CAFgB,MAChB,QAAQ,KAAK,CAAC,CAAC,4CAA4C,EAAE,EAAS,MAAM,CAAA,CAAE,EACvE,EAAE,CAGX,OAAO,EAAS,IAAI,EACtB,CAAE,MAAO,EAAO,CAGd,OAFA,aAAa,GACb,QAAQ,KAAK,CAAC,yCAA0C,GACjD,EAAE,AACX,CACF,CAEA,eAAe,IACb,IAAM,EAAa,IAAI,gBACjB,EAAU,WAAW,IAAM,EAAW,KAAK,GAAI,KAErD,GAF6D,AAEzD,CAEF,IAAM,EAAgB,CADF,MAHqD,AAG/C,CAAA,EAAA,EAAA,OAAA,AAAO,GAAA,EACC,GAAG,CAAC,eAEtC,GAAI,CAAC,EACH,OAAO,KAGT,CAJoB,GAId,EAAS,CAAA,EAAA,EAAA,iBAAA,AAAiB,IAChC,QAAQ,GAAG,CAAC,CAAC,sBAAsB,EAAE,EAAO,OAAO,CAAC,EACpD,IAAM,EAAW,MAAM,MAAM,CAAA,EAAG,EAAO,OAAO,CAAC,CAAE,CAC/C,OAAQ,EAAW,MAAM,CACzB,QAAS,CAAE,OAAQ,CAAC,YAAY,EAAE,EAAc,KAAK,CAAA,CAAG,AAAD,EACvD,MAAO,UACT,GAIA,GAFA,aAAa,GAET,CAAC,EAAS,EAAE,CAEd,CAFgB,MAChB,QAAQ,KAAK,CAAC,CAAC,4BAA4B,EAAE,EAAS,MAAM,CAAA,CAAE,EACvD,KAGT,OAAO,EAAS,IAAI,EACtB,CAAE,MAAO,EAAO,CAGd,OAFA,aAAa,GACb,QAAQ,KAAK,CAAC,mCAAoC,GAC3C,IACT,CACF,CAEe,eAAe,EAAY,CACxC,cAAY,CAGb,EAEc,AACT,CAAC,KADc,CACR,IACT,CAAA,EAAA,EAAA,QAAA,AAAQ,EAAC,KAIX,IAAM,EAAa,MAAM,IAInB,EAAgB,CADP,MAAM,CAAA,EACQ,QAAQ,CAErC,MAAO,CAAA,EAAA,EAAA,GAAA,EAAC,EAAA,OAAa,CAAA,CAAC,kBAAmB,EAAY,cAAe,GACtE,mCArGkC,CAChC,MAAO,4BACP,YAAa,2HACb,SAAU,oGACV,UAAW,CACT,MAAO,4BACP,YAAa,2HACb,KAAM,SACR,EACA,QAAS,CACP,KAAM,sBACN,MAAO,4BACP,YAAa,0HACf,CACF","ignoreList":[1]}